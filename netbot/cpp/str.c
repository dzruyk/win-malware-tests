#include <stdarg.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <Shlwapi.h>
#include "str.h"

static int
str_vsnprintf(char *dst, int sz, char *fmt, va_list list)
{
	return wvnsprintf(dst, sz, fmt, list);
}

static int
str_vsprintf(char *dst, char *fmt, va_list list)
{
	//FIXME: workaround 
	return str_vsnprintf(dst, 0x0fffff, fmt, list);
}

int
str_consume(char *str)
{
	char *ch;
	int i = 0;

	while ((ch = strchr(str, '\x0d')) != NULL) {
		*ch = '\0';
		i++;
	}

	while ((ch = strchr(str, '\x0a')) != NULL) {
		*ch = '\0';
		i++;
	}

	return i;
}


int
str_sprintf(char *str, char *fmt, ...)
{
	va_list list;
	
	va_start(list, fmt);
	return str_vsprintf(str, fmt, list);
}

bool
str_sprintf_ex(char **str, char *fmt, ...)
{
	int sz = 0;
	va_list list;

	va_start(list, fmt);
//not tested yet
	while ((sz += 256) < SPRINTF_EX_MAX_SZ) {
		int n;
		*str = xrealloc(*str, sz);
		n = str_vsnprintf(*str, sz, fmt, list);
		if (n <= sz) /* vspnprintf write all string */
			return true;
	}
	return false;
}

bool
str_cat_ex(char **dst, const char *src)
{
	int dst_sz, src_sz;
	
	if (*dst == NULL)
		dst_sz = 0;
	else
		dst_sz = strlen(*dst);
	src_sz = strlen(src);

	*dst = xrealloc(*dst, dst_sz + src_sz + 1);
	memcpy(*dst + dst_sz, src, src_sz + 1);

	return true;
}

bool
str_cat(char *dst, const char *src)
{
	int dst_sz, src_sz;

	dst_sz = strlen(dst);
	src_sz = strlen(src);

	memcpy(dst + dst_sz, src, src_sz + 1);

	return true;
}

char *
str_ncpy(char *dst, const char *src, int sz)
{
	return strncpy(dst, src, sz);
}

int
str_len(const char *str)
{
	/*
	int i;

	i = 0;
	while (*str++ != '\0')
		i++;
	return i;
	*/
	return strlen(str);
}


