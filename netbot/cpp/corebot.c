#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "common.h"
#include "log.h"
#include "messages.h"
#include "corebot.h"

#define BUF_SZ 1024

void
bot_init(struct bot *bot)
{
	DEBUG(LOG_VERBOSE, "bot initialisation\n");
	
	bot->socket = (struct socket *)xmalloc(sizeof(struct socket));
	socket_init(bot->socket);
}

bool
bot_set_ip(struct bot *bot, char *serv_ip)
{
	DEBUG(LOG_VERBOSE, "bot set IP\n");

	return socket_set_ip(bot->socket, serv_ip);
}

bool
bot_set_port(struct bot *bot, char *serv_port)
{
	DEBUG(LOG_VERBOSE, "bot set port\n");
	
	return socket_set_port(bot->socket, serv_port);
}

bool
bot_init_connection(struct bot *bot)
{
	DEBUG(LOG_VERBOSE, "bot init connection\n");
	
	return socket_connect(bot->socket);
}

bool
bot_main_loop(struct bot *bot)
{
	struct command_ctx ctx;

	if (bot_hand_shake(bot) == false)
		return false;

	do {
		if (bot_get_next_cmd(bot, &ctx) == false) {
			DEBUG(LOG_DEFAULT, "sock error\n");
			goto err;
		}
		if (ctx.cmd == CMD_UNKNOWN)
			goto err;
		command_run(bot, &ctx);
		//need check connection
		DEBUG(LOG_VERBOSE, "next main loop iter\n");
	} while (ctx.cmd != CMD_BYE && bot->socket->is_closed != 1);


	return true;
err:
	return false;
}

bool
bot_get_next_cmd(struct bot *bot, struct command_ctx *ctx)
{
	char buff[BUF_SZ];
	int len;

	if (socket_recv_line(bot->socket, buff, &len, BUF_SZ) == false)
		return false;
	
	buff[len] = '\0';
	DEBUG(LOG_VERBOSE, "recived msg = %s\n", buff);

	command_get(buff, len, ctx);

	return true;
}

bool
bot_hand_shake(struct bot *bot)
{
	char buff[128];
	int len;
	bool ret;

	ret = socket_send_msg(bot->socket, HELLO_MSG, strlen(HELLO_MSG));
	if (ret == false) {
		DEBUG(LOG_DEFAULT, "send_msg handshake fail\n");
		return false;
	}

	ret = socket_recv_line(bot->socket, buff, &len, sizeof(buff));
	
	if (ret == false) {
		DEBUG(LOG_DEFAULT, "send_msg handshake fail\n");
		return false;
	}
	
	if (bot_validate_server(bot, buff, len) == false) {
		DEBUG(LOG_DEFAULT, "Host validation fail\n");
		return false;
	}

	DEBUG(LOG_DEFAULT, "hand shake success\n");

	return true;
}

bool
bot_validate_server(struct bot *bot, char *msg, int sz)
{
	DEBUG(LOG_VERBOSE, "recieved msg is %s sz = %d\n",
	    msg, sz);

	if (strncmp(HELLO_ACK, msg, sz) != 0)
		return false;

	return true;
}

bool
bot_close_connection(struct bot *bot)
{
	DEBUG(LOG_VERBOSE, "bot close connection\n");

	return socket_close(bot->socket);
}

