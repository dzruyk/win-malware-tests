#include <Windows.h>

#include <Shlwapi.h>
#include "str.h"
#include "utils.h"

#pragma comment(lib, "shlwapi")

static int
str_vsnprintf(wchar_t *dst, int sz, wchar_t *fmt, va_list list)
{
	return wvnsprintf(dst, sz, fmt, list);
}

static int
str_vsprintf(wchar_t *dst, wchar_t *fmt, va_list list)
{
	//FIXME: workaround 
	return str_vsnprintf(dst, 0x0fffff, fmt, list);
}

int
str_consume(wchar_t *str)
{
	wchar_t *ch;
	int i = 0;

	while ((ch = StrChr(str, '\x0d')) != NULL) {
		*ch = '\0';
		i++;
	}

	while ((ch = StrChr(str, '\x0a')) != NULL) {
		*ch = '\0';
		i++;
	}

	return i;
}


int
str_sprintf(wchar_t *str, wchar_t *fmt, ...)
{
	va_list list;
	
	va_start(list, fmt);
	return str_vsprintf(str, fmt, list);
}

bool
str_sprintf_ex(wchar_t **str, wchar_t *fmt, ...)
{
	int sz = 0;
	va_list list;

	va_start(list, fmt);
//not tested yet
	while ((sz += 256) < SPRINTF_EX_MAX_SZ) {
		int n;
		*str = (wchar_t *)xrealloc((LPVOID *)*str, sz);
		n = str_vsnprintf(*str, sz, fmt, list);
		if (n <= sz) /* vspnprintf write all string */
			return true;
	}
	return false;
}

bool
str_cat_ex(wchar_t **dst, const wchar_t *src)
{
	int dst_sz, src_sz;
	
	if (*dst == NULL)
		dst_sz = 0;
	else
		dst_sz = str_len(*dst);
	src_sz = str_len(src);

	*dst = (wchar_t *)xrealloc((LPVOID *)*dst, dst_sz + src_sz + 1);
	memcpy(*dst + dst_sz, src, src_sz + 1);

	return true;
}

bool
str_cat(wchar_t *dst, const wchar_t *src)
{
	int dst_sz, src_sz;

	dst_sz = str_len(dst);
	src_sz = str_len(src);

	memcpy(dst + dst_sz, src, src_sz + 1);

	return true;
}

wchar_t *
str_ncpy(wchar_t *dst, const wchar_t *src, int sz)
{
	if (str_len(src) >= sz)
		return NULL;
	return StrCpyW(dst, src);
}

int
str_len(const wchar_t *str)
{
	/*
	int i;

	i = 0;
	while (*str++ != '\0')
		i++;
	return i;
	*/
	return  wcslen(str);
}

